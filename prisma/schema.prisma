// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // オプション: Supabaseの接続プールを使用する場合
}

// ==================== ユーザー ====================
// Supabase AuthのユーザーIDと連携
model User {
  id            String    @id @default(uuid())
  supabaseId    String    @unique // Supabase AuthのユーザーID
  name          String?
  email         String?   @unique
  lineId        String?   @unique // LINE ID（オプション）
  displayName   String?   // 表示名
  avatarUrl     String?   // アバターURL
  role          UserRole  @default(JOB_SEEKER) // ユーザーロール
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // リレーション
  ownedGroups   Group[]         @relation("GroupOwner")
  groupMembers  GroupMember[]
  applications  Application[]
  notifications Notification[]
  friends       Friend[]        @relation("UserFriends")
  friendOf      Friend[]        @relation("FriendOfUser")
  createdJobs   Job[]           @relation("JobEmployer")

  @@index([supabaseId])
  @@index([lineId])
  @@index([role])
  @@map("users")
}

enum UserRole {
  EMPLOYER
  JOB_SEEKER
}

// ==================== グループ ====================
model Group {
  id            String   @id @default(uuid())
  ownerId       String
  ownerName     String   // グループ作成者の名前
  jobId         String?  // 求人ID（求人ごとにグループを作成）
  requiredCount Int?     // 希望者数（応募に必要な人数）
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // リレーション
  owner         User         @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members       GroupMember[]
  applications  Application[]

  @@index([ownerId])
  @@index([jobId])
  @@map("groups")
}

// ==================== グループメンバー ====================
model GroupMember {
  id               String                    @id @default(uuid())
  groupId          String
  userId           String?                   // ユーザーID（ログイン済みの場合）
  name             String                    // メンバー名
  lineId           String?                   // LINE ID
  inviteLink       String?                   // 招待リンク
  status           GroupMemberStatus         @default(PENDING)
  applicationStatus ApplicationParticipationStatus? // 応募への参加状況
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  // リレーション
  group            Group                     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user             User?                     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

enum GroupMemberStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ApplicationParticipationStatus {
  PARTICIPATING
  NOT_PARTICIPATING
  PENDING
}

// ==================== 求人カテゴリ ====================
enum JobCategory {
  ONE_TIME_JOB  // 単発バイト
  PART_TIME     // 中長期アルバイト
  INTERNSHIP    // インターンシップ
  VOLUNTEER     // ボランティア
}

// ==================== 報酬形式 ====================
enum CompensationType {
  HOURLY    // 時給
  DAILY     // 日給
  MONTHLY   // 月給
  FIXED     // 固定報酬
  NONE      // 無給
}

// ==================== 求人 ====================
model Job {
  id                  String            @id @default(uuid())
  category            JobCategory       @default(ONE_TIME_JOB) // 求人カテゴリ
  title               String?
  summary             String?           // サマリー（100〜200文字、必須）
  description         String?
  location            String?
  
  // 報酬関連（新フィールド）
  compensationType    CompensationType  @default(HOURLY) // 報酬形式
  compensationAmount  Int?              // 報酬額
  wageAmount          Int?              // 時給（円）- 後方互換性のため残す
  transportFee        Int?              // 交通費（円）
  
  // 日時関連
  jobDate             DateTime?         // シフト日時（単発バイト用）
  startDate           DateTime?         // 勤務開始日（長期/インターン用）
  endDate             DateTime?         // 勤務終了日（長期/インターン用）
  isFlexibleSchedule  Boolean?          // シフト柔軟性フラグ
  
  // 外部リンク・添付ファイル
  externalUrl         String?           // 外部求人ページURL
  externalUrlTitle    String?           // 外部URLのタイトル
  attachmentUrls      String?           // 添付ファイルURL（JSON配列形式）
  
  companyId           String?
  companyName         String?           // 会社名・店舗名
  workHours           String?           // 勤務時間（例：9:00～18:00 (昼60分休憩)）
  recruitmentCount    Int?              // 募集人数
  jobContent          String?           // 業務内容
  requirements        String?           // 応募資格・条件
  applicationDeadline DateTime?         // 応募締め切り
  notes               String?           // 備考
  employerId          String            // 求人作成者ID（必須）
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // リレーション
  applications  Application[]
  employer      User          @relation("JobEmployer", fields: [employerId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([jobDate])
  @@index([startDate])
  @@index([employerId])
  @@index([applicationDeadline])
  @@map("jobs")
}

// ==================== 応募 ====================
model Application {
  id            String              @id @default(uuid())
  jobId         String
  groupId       String?              // グループID（グループ応募の場合）
  applicantId   String              // 応募者（あなた）
  status        ApplicationStatus   @default(PENDING)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // リレーション
  job           Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  group         Group?              @relation(fields: [groupId], references: [id], onDelete: SetNull)
  applicant     User                @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([groupId])
  @@index([applicantId])
  @@index([status])
  @@map("applications")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

// ==================== 通知 ====================
model Notification {
  id                String             @id @default(uuid())
  userId            String             // 通知を受けるユーザー
  type              NotificationType
  applicationId     String?            // 応募ID
  jobId             String?             // 求人ID
  jobTitle          String?            // 求人タイトル
  fromUserName      String?            // 通知を送ったユーザー名
  message           String
  read              Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // リレーション
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  APPLICATION_INVITATION
  APPLICATION_APPROVED
  APPLICATION_REJECTED
}

// ==================== 友達 ====================
model Friend {
  id           String   @id @default(uuid())
  userId       String   // 友達を追加したユーザーID
  friendUserId String?  // 友達のユーザーID（ログイン済みの場合）
  name         String   // 友達の名前
  email        String?  // 友達のメールアドレス
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // リレーション
  user         User     @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend       User?    @relation("FriendOfUser", fields: [friendUserId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([friendUserId])
  @@map("friends")
}
